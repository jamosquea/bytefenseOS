#!/bin/bash
# Bytefense OS - RustDesk Linux Installer

set -e

CONFIG="$1"
PASSWORD="$2"

echo "ðŸ” Obteniendo Ãºltima versiÃ³n de RustDesk..."

# Obtener la Ãºltima versiÃ³n desde GitHub API
VERSION=$(curl -s "https://api.github.com/repos/rustdesk/rustdesk/releases/latest" | grep '"tag_name":' | cut -d '"' -f4 | tr -d 'v')

if [ -z "$VERSION" ]; then
    echo "âŒ Error: No se pudo obtener la versiÃ³n de RustDesk"
    exit 1
fi

echo "ðŸ“¦ VersiÃ³n detectada: $VERSION"

# Detectar arquitectura
ARCH=$(uname -m)
case $ARCH in
    x86_64)
        FILE="rustdesk-${VERSION}-x86_64.deb"
        ;;
    aarch64|arm64)
        FILE="rustdesk-${VERSION}-aarch64.deb"
        ;;
    *)
        echo "âŒ Arquitectura no soportada: $ARCH"
        exit 1
        ;;
esac

echo "â¬‡ï¸ Descargando RustDesk $VERSION para $ARCH..."
DOWNLOAD_URL="https://github.com/rustdesk/rustdesk/releases/download/${VERSION}/${FILE}"

# Descargar con verificaciÃ³n
if ! wget -q --show-progress "$DOWNLOAD_URL"; then
    echo "âŒ Error al descargar RustDesk desde $DOWNLOAD_URL"
    exit 1
fi

echo "ðŸ“¦ Instalando RustDesk..."
sudo dpkg -i "$FILE" || {
    echo "ðŸ”§ Resolviendo dependencias..."
    sudo apt-get update
    sudo apt-get install -f -y
    sudo dpkg -i "$FILE"
}

# Limpiar archivo descargado
rm -f "$FILE"

echo "âš™ï¸ Configurando RustDesk para Bytefense..."

# Configurar RustDesk
if [ -n "$CONFIG" ]; then
    rustdesk --config "$CONFIG" || echo "âš ï¸ Advertencia: No se pudo aplicar configuraciÃ³n personalizada"
fi

if [ -n "$PASSWORD" ]; then
    rustdesk --password "$PASSWORD" || echo "âš ï¸ Advertencia: No se pudo establecer contraseÃ±a"
fi

# Obtener ID de RustDesk
echo "==============================================="
echo "ðŸ†” RustDesk ID: $(rustdesk --get-id 2>/dev/null || echo 'No disponible')"
echo "ðŸ”‘ Password: $PASSWORD"
echo "ðŸŒ ConfiguraciÃ³n: $CONFIG"
echo "==============================================="

# Crear servicio systemd para Bytefense
echo "ðŸ”§ Creando servicio systemd..."
sudo tee /etc/systemd/system/bytefense-rustdesk.service > /dev/null << EOF
[Unit]
Description=Bytefense RustDesk Remote Access
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/bin/rustdesk --service
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable bytefense-rustdesk.service

echo "ðŸš€ Iniciando RustDesk en segundo plano..."
rustdesk &

echo "âœ… RustDesk instalado y configurado exitosamente para Bytefense OS"