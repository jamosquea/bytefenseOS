#!/bin/bash
# Bytefense OS - Script de Post-instalaciÃ³n

set -e

BYTEFENSE_HOME="/opt/bytefense"
BYTEFENSE_USER="bytefense"
LOG_FILE="/var/log/bytefense-install.log"

# FunciÃ³n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

case "$1" in
    configure)
        log "ğŸ›¡ï¸ Configurando Bytefense OS..."
        
        # Crear directorios adicionales
        log "ğŸ“ Creando estructura de directorios..."
        mkdir -p "$BYTEFENSE_HOME"/{intel,honey,wireguard,logs}
        
        # Establecer permisos correctos
        log "ğŸ” Configurando permisos..."
        chown -R "$BYTEFENSE_USER":"$BYTEFENSE_USER" "$BYTEFENSE_HOME"
        chmod +x "$BYTEFENSE_HOME/bin/"*
        
        # Crear enlace simbÃ³lico para comando global
        log "ğŸ”— Creando enlace simbÃ³lico..."
        ln -sf "$BYTEFENSE_HOME/bin/bytefense-ctl" /usr/local/bin/bytefense-ctl
        
        # Recargar systemd
        log "âš™ï¸ Recargando systemd..."
        systemctl daemon-reload
        
        # Habilitar servicios (pero no iniciar aÃºn)
        log "ğŸš€ Habilitando servicios..."
        systemctl enable bytefense-dashboard.service
        systemctl enable bytefense-watch.service
        
        # Inicializar base de datos
        log "ğŸ—„ï¸ Inicializando base de datos..."
        if [ ! -f "$BYTEFENSE_HOME/intel/threats.db" ]; then
            sqlite3 "$BYTEFENSE_HOME/intel/threats.db" < "$BYTEFENSE_HOME/system/schema.sql"
            chown "$BYTEFENSE_USER":"$BYTEFENSE_USER" "$BYTEFENSE_HOME/intel/threats.db"
        fi
        
        # Configurar firewall bÃ¡sico
        log "ğŸ”¥ Configurando firewall bÃ¡sico..."
        ufw --force enable
        ufw default deny incoming
        ufw default allow outgoing
        ufw allow ssh
        ufw allow 8080/tcp comment 'Bytefense Dashboard'
        ufw allow 8081/tcp comment 'Pi-hole Admin'
        ufw allow 51820/udp comment 'WireGuard VPN'
        
        # Instalar Pi-hole si no estÃ¡ instalado
        if ! command -v pihole &> /dev/null; then
            log "ğŸ•³ï¸ Instalando Pi-hole..."
            curl -sSL https://install.pi-hole.net | bash /dev/stdin --unattended
        fi
        
        log "âœ… ConfiguraciÃ³n completada"
        
        # Mostrar informaciÃ³n post-instalaciÃ³n
        echo ""
        echo "ğŸ›¡ï¸ Bytefense OS instalado correctamente"
        echo "ğŸ“Š Para configurar el sistema, ejecuta: sudo bytefense-ctl init"
        echo "ğŸŒ Dashboard estarÃ¡ disponible en: http://$(hostname -I | awk '{print $1}'):8080"
        echo "ğŸ•³ï¸ Pi-hole estarÃ¡ disponible en: http://$(hostname -I | awk '{print $1}'):8081/admin"
        echo "ğŸ“– DocumentaciÃ³n: /usr/share/doc/bytefense-os/"
        echo ""
        echo "âš ï¸ IMPORTANTE: Ejecuta 'sudo bytefense-ctl init' para completar la configuraciÃ³n"
        
        # Preguntar si desea ejecutar la configuraciÃ³n inicial
        if [ -t 0 ]; then  # Solo si hay terminal interactiva
            echo ""
            read -p "Â¿Deseas ejecutar la configuraciÃ³n inicial ahora? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                log "ğŸš€ Ejecutando configuraciÃ³n inicial..."
                "$BYTEFENSE_HOME/bin/bytefense-ctl" init
                
                # Iniciar servicios despuÃ©s de la configuraciÃ³n
                systemctl start bytefense-dashboard.service
                systemctl start bytefense-watch.service
                
                echo "âœ… Bytefense OS configurado e iniciado"
            else
                echo "â„¹ï¸ Puedes ejecutar la configuraciÃ³n mÃ¡s tarde con: sudo bytefense-ctl init"
            fi
        fi
        ;;
        
    abort-upgrade|abort-remove|abort-deconfigure)
        log "âŒ InstalaciÃ³n abortada: $1"
        ;;
        
    *)
        log "â“ AcciÃ³n desconocida: $1"
        ;;
esac

exit 0