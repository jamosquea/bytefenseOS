#!/bin/bash
# Bytefense OS - Script de Post-eliminaci√≥n

set -e

BYTEFENSE_HOME="/opt/bytefense"
BYTEFENSE_USER="bytefense"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "/var/log/bytefense-remove.log"
}

case "$1" in
    remove)
        log "üßπ Limpiando archivos de Bytefense OS..."
        
        # Eliminar enlace simb√≥lico
        rm -f /usr/local/bin/bytefense-ctl
        
        # Recargar systemd
        systemctl daemon-reload
        
        log "‚úÖ Limpieza b√°sica completada"
        echo "‚ÑπÔ∏è Los datos en $BYTEFENSE_HOME se mantienen para seguridad"
        echo "‚ÑπÔ∏è Para eliminar completamente: sudo rm -rf $BYTEFENSE_HOME"
        ;;
        
    purge)
        log "üóëÔ∏è Eliminaci√≥n completa de Bytefense OS..."
        
        # Eliminar completamente el directorio
        rm -rf "$BYTEFENSE_HOME"
        
        # Eliminar usuario del sistema
        if id "$BYTEFENSE_USER" &>/dev/null; then
            userdel "$BYTEFENSE_USER" 2>/dev/null || true
        fi
        
        # Eliminar logs
        rm -f /var/log/bytefense-*.log
        
        log "‚úÖ Eliminaci√≥n completa finalizada"
        ;;
        
    upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
        # No hacer nada en estos casos
        ;;
        
    *)
        log "‚ùì Acci√≥n desconocida: $1"
        ;;
esac

exit 0